from xbmctorrent import plugin
from xbmctorrent.scrapers import scraper
from xbmctorrent.ga import tracked


BASE_URL = "%s/" % plugin.get_setting("base_tpb")
HEADERS = {
    "Referer": BASE_URL,
}
CATEGORIES = [
    ("Audio", 100, [
        ("Music", 101),
        ("Audio Books", 102),
        ("Sound clips", 103),
        ("FLAC", 104),
        ("Other", 199),
    ]),
    ("Video", 200, [
        ("Movies", 201),
        ("Movies DVDR", 202),
        ("Music videos", 203),
        ("Movie clips", 204),
        ("TV shows", 205),
        ("Handheld", 206),
        ("HD - Movies", 207),
        ("HD - TV shows", 208),
        ("3D", 209),
        ("Other", 299),
    ]),
    ("Porn", 500, [
        ("Movies", 501),
        ("Movies DVDR", 502),
        ("HD - Movies", 503),
        ("Movie clips", 504),
        ("Other", 599),
    ]),
]


@scraper("The Pirate Bay - Movies and Series", "http://thepiratebay.sx/static/img/tpb.jpg")
@plugin.route("/tpb")
@tracked
def piratebay_index():
    return [
        {"label": "Search", "path": plugin.url_for("piratebay_search"), "is_playable": False},
        {"label": "Browse Torrents", "path": plugin.url_for("piratebay_browse_categories"), "is_playable": False},
    ]


@plugin.route("/tpb/browse")
@tracked
def piratebay_browse_categories():
    def make_cats(root, prefix=""):
        for cat in root:
            yield {
                "label": "%s%s" % (prefix, cat[0]),
                "path": plugin.url_for("piratebay_page", root="/browse/%d" % cat[1], page=0),
            }
            if len(cat) > 2:
                for entry in make_cats(cat[2], prefix="%s  " % prefix):
                    yield entry

    for cat in make_cats(CATEGORIES):
        yield cat


@plugin.route("/tpb/<root>/<page>")
@tracked
def piratebay_page(root, page):
    import re
    from bs4 import BeautifulSoup
    from urlparse import urljoin
    from xbmctorrent.utils import url_get

    page = int(page)
    html_data = url_get(urljoin(BASE_URL, "%s/%d/7/0" % (root, page)), headers=HEADERS)
    soup = BeautifulSoup(html_data, "html5lib")
    nodes = soup.findAll("div", "detName")

    next_page = {
        "label": "Next page...",
        "path": plugin.url_for("piratebay_page", root=root, page=page + 1),
        "is_playable": False,
    }
    yield next_page
    for node in nodes:
        seeds, peers = map(lambda x: x.text, node.parent.parent.findAll("td")[2:])
        magnet_node = node.parent.findAll("a")[1]
        desc_node = node.parent.findAll("font", "detDesc")[0]
        size = re.search("Size (.*?),", desc_node.text).group(1)
        text = "%s (%s S:%s P:%s)" % (node.a.text, size.replace("&nbsp;", " "), seeds, peers)
        yield {
            "label": text,
            "path": plugin.url_for("play", magnet=magnet_node["href"]),
            "is_playable": True,
        }
    yield next_page


@plugin.route("/tpb/search")
@tracked
def piratebay_search():
    import urllib

    query = plugin.request.args.get("query")
    if query:
        query = query[0]
    else:
        query = plugin.keyboard("", "XBMCtorrent - The Pirate Bay - Search")
    if query:
        plugin.redirect(plugin.url_for("piratebay_page", root="/search/%s" % urllib.quote(query), page=0))
